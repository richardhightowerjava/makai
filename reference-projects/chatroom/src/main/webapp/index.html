<html>
<head>

    <link href="/common/thirdparty/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="/common/thirdparty/js/jquery.min.js"></script>
    <script type="text/javascript" src="/common/thirdparty/js/bootstrap.js"></script>
    <script type="text/javascript" src="/common/js/makai.js"></script>

    <script type="text/javascript">

        var user = undefined;

        $(function() {
            //Configure a webservice url for the Makai web service.
            //This should be respective to the contents of your resin-web.xm
            //configuration of the JampServlet
            var wssUrl = "ws://localhost:8080/chatroom/jamp";

            //Open a websocket connection to the Makai service
            /**
             *   Register the websocket, which returns a deferred,
             *   and add an 'initializer methods the app requires for
             *   backend communication once the url is open.
             */
            /**
             *  Aside from the wssUrlThis object can have configured callbacks via additional
             * parameter, including
             * {
             *      logNode: a div reference where you want log messages to spit out, in addition to console
             *      onMessage: function,
             *      onError: function,
             *      onOpen: function,
             *      onClose: function
             * }
             */
            var options = { logNode: '#messages'};
            MAKAI.Server
                    .registerSocket(wssUrl, options, serverMessages)
                    .done(function() {
                        //Socket is open, get the initial list.
                        //Check to see if there is a user yet, if not, force one.
                        if (user == undefined) {
                            $('#userModalWrapper').modal('show');
                            $('#showChatsList').on('click', setup);
                        } else {
                            setup();
                        }


                        // Register a listener for callbacks fired in the service.
                        // Note: This does NOT trigger any events or server responses, it just registers this
                        // connection with the service class which can subsequently notify this page of certain events.
                        //MAKAI.Server.registerClientListener("/chatroomAPI", "registerActiveRoomWithUser");
                    })
                    .fail(function() {
                        console.log("oops");
                    });

        });


        /**
         * So there is an interesting note around how callbacks are delivered from the server
         * and how we expect the client to handle them. Basically it seems that if we have
         * registered for server messages ala "MAKAI.Server.registerClientListener" then we should
         * probably need to have a "front controller" type of function listener for those "send" responses
         * from the server and decide what to do with them by wrapper type or some sub content therein -
         * the implementation will drive this.
         * @param data
         */
        function serverMessages(method, data) {
            console.log("server side method " + method + " returned ", data);
            if (method == "messageFromServer") {
                updateScoreboard(data);
            }
        }

        function setup() {

            /**
             * Misc plumbing/event handling
             */
//            $('#addParticipantButton').on('click', function() {
//                add();
//            });

            user = $('#particpantNameInput').val();
            $('.participantName').text(user);

            $('#newChatroomButton').on('click', function(evt) {
                var newChatroomName = $('#newChatroomNameInput').val();
                var welcomeMessage = $('#welcomeMessageInput').val();
                console.log("Creating new chatroom with name:" + newChatroomName);
                DEMO.chatroom.createChat(newChatroomName, welcomeMessage, user, updateChats);
            });

            /** List the chats **/
            DEMO.chatroom.listChats(updateChats);

        }


//        function add() {
//            var participant = $('#participantInput').val();
//            var score = $('#scoreInput').val();
//            if (isNaN(score )) {
//                alert("Invalid score. Try again.");
//                return false;
//            }
//            var newEntry = {};
//            newEntry.participant = participant;
//            newEntry.score = new Number(score);
//
//            MAKAI.Server.invokeMakaiMethod("/chatroomService", "addBoardEntry", undefined, newEntry);
//        }
//
//        function removeBoardEntry(participantName) {
//            var discardPile = {};
//            discardPile.participant = participantName;
//            MAKAI.Server.invokeMakaiMethod("/chatroomService", "removeBoardEntry", undefined, discardPile);
//        }

        function updateChats(rooms) {
            var $list = $('#chatroomList');
            $list.empty();
            $.each(rooms, function(index, chatRoom) {
                $list.append(
                        '<tr>' +
                                '<td width="60%">' + chatRoom.welcomeMessage + '</td>' +
                                '<td><button class="btn btn-primary chatroomLink" data-id="' + chatRoom.id + '">' + chatRoom.name + '</button></td>' +
                        '</tr>'

                );
            });

            $('#userModalWrapper').modal('hide');
            $('.chatroomLink').on('click', function(evt) {
                console.log("Launching modal for chat id:" + evt.currentTarget.dataset.id);

            });
        }

        DEMO = window.DEMO || {};
        DEMO.chatroom = (function() {
            var _ = {};

            _.addChatUser = function(handle, callback) {
                MAKAI.Server.invokeMakaiMethod("/chatroomAPI", "addUser", callback);
            }

            _.listChats = function(callback) {
                MAKAI.Server.invokeMakaiMethod("/chatroomAPI", "list", callback);
            }

            _.joinChat = function(id) {
                /** Add listener for chat messages **/
                if (id == undefined || id.length == 0) {
                    throw new Error("ID is required to join room.");
                }

            }

            _.createChat = function(name, welcomeMessage, user, callback) {
                /** Create a new chat, and join it **/
//                var chatroom = {
//                    welcomeMessage: welcomeMessage,
//                    name: name,
//                    createdBy: {
//                        handle: user
//                    }
//                }
                var chatroom=  {};
                chatroom.welcomeMessage = welcomeMessage;
                chatroom.name = name;
                chatroom.user = {};
                chatroom.user.handle = user;

                MAKAI.Server.sendServerMakaiMessage("/chatroomAPI", "createChat", callback, chatroom);
            }
            return _;
        })();

    </script>

</head>
<body style="padding: 10px">
    <div class="page-header">
        <h1>Chatroom Example<small>  Demonstrating @Store and friends to <span class="participantName"></span></small></h1>
    </div>
    <div>
        <p>Welcome <span class="participantName"></span>, please select a chatroom to join, or create your own!</p>

    </div>

    <!-- This gets dynamically filled in the updateChats method based on server 'list' -->
    <div>
        <table class="table-bordered" id="chatroomList">
        </table>
    </div>

    <div>
        <div class="control-group">
            <form class="form-inline">
                <label>Room Name: </label>
                <input type="text" class="input-medium" id="newChatroomNameInput" placeholder="Room Name">
                <input type="text" class="input-medium" id="welcomeMessageInput" placeholder="Welcome Message">
                <button class="btn" id="newChatroomButton">create chat room</button>


            </form>
        </div>

    <!--div style="clear: both">
        <form onsubmit="return false">
            <label for="participantInput">Participant:</label>
            <input type="text" id="participantInput" name="participantInput" placeholder="enter name" />
            <label for="participantInput">Score:</label>
            <input type="text" id="scoreInput" name="scoreInput" placeholder="enter score" />
            <button id="addParticipantButton">add/update</button>
        </form>
    </div-->
    <br />
    <hr/>
    <div id="messages" style="margin: auto; clear: both"></div>


        <div id="userModalWrapper" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <h3 id="myModalLabel">Enter a Handle (user name)</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="particpantNameInput" class="input-medium" placeholder="user handle" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="showChatsList">show chats list</button>
            </div>
        </div>

        <div id="roomModalWrapper" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h3 id="chatroomLabel">{{Chat Room Name}}</h3>
            </div>
            <div class="modal-body">
                <div id="chatMessages"></div>
                <div id="inputDiv">
                    <textarea rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <!--button class="btn" data-dismiss="modal" aria-hidden="true">Close</button-->
                <button class="btn btn-primary">send</button>
            </div>
        </div>

</body>
</html>